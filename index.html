<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextDNS Ultra-Blocker 100%</title>
    <style>
        :root {
            --primary: #6366f1;
            --danger: #ef4444;
            --success: #22c55e;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }

        body {
            background-color: #0f172a;
            color: var(--light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .card {
            background: #1e293b;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { font-size: 24px; color: #fff; margin-bottom: 5px; }
        .header p { color: #94a3b8; font-size: 14px; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; }
        input {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f172a;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); margin-right: 8px; display: inline-block; }
        .status-dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4f46e5; transform: translateY(-1px); }
        .btn-danger { background: #334155; color: #fff; border: 1px solid #475569; }
        .btn-danger.active { background: var(--danger); border-color: var(--danger); }

        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-item { background: #0f172a; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        .stat-val { font-size: 20px; font-weight: 800; color: #fff; }
        .stat-lab { font-size: 10px; color: #94a3b8; text-transform: uppercase; }

        .logs {
            background: #0f172a;
            height: 150px;
            border-radius: 10px;
            padding: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            overflow-y: auto;
            border: 1px solid #334155;
        }
        .log-line { margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid #1e293b; }
        .log-time { color: #64748b; }
        .log-msg { color: #cbd5e1; }
        .log-blocked { color: var(--danger); font-weight: bold; }

        .alert { padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 15px; display: none; }
        .alert-error { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
    </style>
</head>
<body>
    <div class="card">
        <div class="header">
            <h1>ULTRA-BLOCKER 100%</h1>
            <p>Monitoramento NextDNS Otimizado</p>
        </div>

        <div id="alert" class="alert alert-error"></div>

        <div class="input-group">
            <label>Config ID</label>
            <input type="text" id="configId" placeholder="Ex: 5aee14" spellcheck="false">
        </div>
        <div class="input-group">
            <label>API Key</label>
            <input type="password" id="apiKey" placeholder="Insira sua chave de API" spellcheck="false">
        </div>

        <div class="status-bar">
            <div><span id="dot" class="status-dot"></span> <span id="statusText">SISTEMA OFFLINE</span></div>
            <div id="timer" style="font-size: 12px; color: #64748b;">0s</div>
        </div>

        <button id="mainBtn" class="btn btn-primary" onclick="toggleSystem()">Ligar Sistema</button>
        <button id="totalBtn" class="btn btn-danger" onclick="toggleTotalBlock()">Modo Bloqueio Total: OFF</button>

        <div class="stats">
            <div class="stat-item"><div id="countDet" class="stat-val">0</div><div class="stat-lab">Detectados</div></div>
            <div class="stat-item"><div id="countBlk" class="stat-val">0</div><div class="stat-lab">Bloqueados</div></div>
        </div>

        <div id="logs" class="logs">
            <div class="log-line">Aguardando início...</div>
        </div>
    </div>

    <script>
        let active = false;
        let totalBlock = false;
        let interval = null;
        let lastCheck = 0;
        const keywords = ["freefire", "garena", "beetalk", "garenanow"];

        // Carregar ID salvo
        document.getElementById('configId').value = localStorage.getItem('nextdns_id') || '';

        function log(msg, type = '') {
            const div = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const line = `<div class="log-line"><span class="log-time">[${time}]</span> <span class="log-msg ${type}">${msg}</span></div>`;
            div.innerHTML = line + div.innerHTML;
            if (div.children.length > 30) div.removeChild(div.lastChild);
        }

        async function api(path, method = 'GET', body = null) {
            const id = document.getElementById('configId').value.replace(/\s/g, '');
            const key = document.getElementById('apiKey').value.replace(/\s/g, '');
            
            try {
                const res = await fetch(`https://api.nextdns.io/profiles/${id}${path}`, {
                    method,
                    headers: { 'X-Api-Key': key, 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : null
                });
                if (res.status === 403 || res.status === 401) throw new Error("API Key Inválida");
                if (!res.ok && res.status !== 204) throw new Error("Erro na Rede");
                return res.status === 204 ? true : await res.json();
            } catch (e) {
                log(e.message, 'log-blocked');
                return null;
            }
        }

        async function process() {
            const id = document.getElementById('configId').value.replace(/\s/g, '');
            const key = document.getElementById('apiKey').value.replace(/\s/g, '');
            
            const logs = await api('/logs');
            if (!logs || !logs.data) return;

            const blacklistData = await api('/denylist');
            const blacklisted = new Set(blacklistData?.data?.map(i => i.id) || []);

            for (const entry of logs.data) {
                const domain = entry.domain;
                if (!domain) continue;

                const match = totalBlock || keywords.some(k => domain.toLowerCase().includes(k));
                
                if (match && !blacklisted.has(domain)) {
                    document.getElementById('countDet').innerText = parseInt(document.getElementById('countDet').innerText) + 1;
                    log(`Detectado: ${domain}`);
                    const ok = await api('/denylist', 'POST', { id: domain });
                    if (ok) {
                        document.getElementById('countBlk').innerText = parseInt(document.getElementById('countBlk').innerText) + 1;
                        log(`BLOQUEADO: ${domain}`, 'log-blocked');
                    }
                }
            }
        }

        function toggleSystem() {
            const id = document.getElementById('configId').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            
            if (!id || !key) {
                document.getElementById('alert').innerText = "Preencha ID e API Key!";
                document.getElementById('alert').style.display = "block";
                return;
            }
            document.getElementById('alert').style.display = "none";
            localStorage.setItem('nextdns_id', id);

            active = !active;
            const btn = document.getElementById('mainBtn');
            const dot = document.getElementById('dot');
            const status = document.getElementById('statusText');

            if (active) {
                btn.innerText = "Desligar Sistema";
                btn.style.background = "#475569";
                dot.classList.add('active');
                status.innerText = "SISTEMA ONLINE";
                log("Sistema iniciado (Check: 10s)");
                process();
                interval = setInterval(process, 10000);
            } else {
                btn.innerText = "Ligar Sistema";
                btn.style.background = "var(--primary)";
                dot.classList.remove('active');
                status.innerText = "SISTEMA OFFLINE";
                clearInterval(interval);
                log("Sistema desligado");
            }
        }

        function toggleTotalBlock() {
            totalBlock = !totalBlock;
            const btn = document.getElementById('totalBtn');
            if (totalBlock) {
                btn.innerText = "Modo Bloqueio Total: ON";
                btn.classList.add('active');
                log("⚠️ BLOQUEIO TOTAL ATIVADO!", "log-blocked");
            } else {
                btn.innerText = "Modo Bloqueio Total: OFF";
                btn.classList.remove('active');
                log("Bloqueio Total desativado");
            }
        }
    </script>
</body>
</html>
